# EmelyanovTGBot - Local ngrok Version

Версия для локального запуска через ngrok с системой сохранения прогресса пользователя в JSON.

## Особенности

- **Система прогресса**: Автоматически сохраняет прогресс пользователя и перенаправляет на последнюю посещенную страницу
- **JSON хранилище**: Все данные сохраняются в читаемом JSON файле
- **Username пользователя**: Сохраняется username с символом @ при запуске бота
- **Данные формы**: Автоматически сохраняются при заполнении формы
- **API**: REST API для работы с данными пользователей
- **Мобильная совместимость**: Оптимизировано для мобильных устройств

## Установка

1. Создайте виртуальное окружение:
```bash
python3 -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Настройте переменные окружения в файле `env.local`:
```
BOT_TOKEN=your_bot_token_here
WEBAPP_URL=https://your-ngrok-url.ngrok.io
PORT=8001
SERVER_URL=http://localhost:8001
```

## Запуск

1. Запустите ngrok:
```bash
ngrok http 8001
```

2. Скопируйте HTTPS URL из ngrok (например: https://abc123.ngrok.io)

3. Обновите `WEBAPP_URL` в файле `env.local` с вашим ngrok URL

4. Запустите сервер:
```bash
python server.py
```

5. Запустите бота:
```bash
python bot.py
```

## Система прогресса

### Как это работает
- При запуске бота сохраняется username пользователя
- При первом открытии пользователь попадает на страницу 1
- При переходе между страницами прогресс автоматически сохраняется
- При заполнении формы данные сохраняются в JSON
- При следующем открытии пользователь перенаправляется на последнюю посещенную страницу

### API Endpoints
- `GET /api/user/{user_id}` - получить все данные пользователя
- `POST /api/user/{user_id}` - обновить данные пользователя
- `GET /api/progress/{user_id}` - получить прогресс (для совместимости)
- `POST /api/progress/{user_id}` - обновить прогресс (для совместимости)
- `GET /api/users` - получить список всех пользователей

### JSON файл
- Автоматически создается файл `user_data.json`
- Содержит username, данные формы, прогресс и время
- Легко читается и редактируется вручную

## Просмотр данных

Используйте скрипт для просмотра данных пользователей:

```bash
# Показать всех пользователей
python view_users.py

# Показать конкретного пользователя
python view_users.py @username
```

## Структура

- `env.local` - переменные окружения для локального запуска
- `bot.py` - Telegram бот с сохранением username
- `server.py` - Flask сервер с JSON API
- `requirements.txt` - зависимости Python
- `webapp/` - веб-приложение с 14 страницами
- `webapp/progress.js` - система управления прогрессом
- `view_users.py` - скрипт для просмотра данных
- `PROGRESS_SYSTEM.md` - подробная документация по системе прогресса

## Отладка

Для проверки работы системы прогресса:
1. Откройте консоль браузера
2. Используйте команды:
```javascript
// Проверить данные пользователя
await window.progressManager.getUserData()

// Сохранить username
await window.progressManager.saveUsername('@test_user')

// Сохранить данные формы
await window.progressManager.saveFormData({
    age: '25',
    occupation: 'Тест',
    income: '50000',
    motivation: '10',
    teamwork: 'Да'
})

// Перенаправить на последнюю страницу
await window.progressManager.redirectToLastPage()
```

## Безопасность

- ID пользователя генерируется локально в браузере
- Username сохраняется только при запуске бота
- Данные формы сохраняются только при заполнении
- JSON файл хранится локально на сервере
- Все данные анонимны и безопасны 