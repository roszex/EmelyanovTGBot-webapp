# Система прогресса пользователя (JSON)

## Описание

Система автоматически сохраняет прогресс пользователя, username и данные формы в JSON файле. При следующем открытии веб-приложения пользователь перенаправляется на последнюю посещенную страницу.

## Как это работает

### 1. Идентификация пользователя
- При старте бота сохраняется username пользователя (с символом @)
- Если username отсутствует, используется ID пользователя
- Каждому пользователю также генерируется уникальный ID в браузере

### 2. Сохранение данных
- **Username**: Сохраняется при первом запуске бота
- **Прогресс**: При загрузке каждой страницы автоматически сохраняется номер текущей страницы
- **Форма**: При заполнении формы на странице 3 данные сохраняются в JSON
- **Время**: Отслеживается только время создания записи

### 3. Перенаправление
- При открытии первой страницы система проверяет сохраненный прогресс
- Если пользователь уже посещал другие страницы, происходит автоматическое перенаправление
- Если это новый пользователь, остается на первой странице

## Структура данных в JSON

```json
{
  "user_123456789": {
    "username": "@username",
    "form_data": {
      "age": "25",
      "occupation": "Программист",
      "income": "80000 руб/мес",
      "motivation": "10 из 10",
      "teamwork": "Очень хочу работать в команде"
    },
    "current_page": 5,
    "created_at": "29.06.2025 20:14:13"
  }
}
```

## API Endpoints

### GET /api/user/{user_id}
Получает все данные пользователя
```json
{
    "username": "@username",
    "form_data": {...},
    "current_page": 5,
    "created_at": "29.06.2025 20:14:13"
}
```

### POST /api/user/{user_id}
Обновляет данные пользователя
```json
{
    "username": "@new_username",
    "form_data": {...},
    "current_page": 6
}
```

### GET /api/progress/{user_id}
Получает прогресс пользователя (для обратной совместимости)
```json
{
    "user_id": "user_123",
    "current_page": 5
}
```

### POST /api/progress/{user_id}
Обновляет прогресс пользователя (для обратной совместимости)
```json
{
    "page": 6
}
```

### GET /api/users
Получает список всех пользователей (для админа)

## Структура файлов

### progress.js
Основной файл системы прогресса, содержит:
- Класс `ProgressManager` для управления прогрессом
- Функции для сохранения и получения данных пользователя
- Функции для сохранения username и данных формы
- Автоматическую инициализацию при загрузке страницы

### server.py
Серверная часть с:
- JSON файлом для хранения данных пользователей
- API endpoints для работы с данными
- Функциями загрузки и сохранения JSON
- Читаемым форматом времени создания

### bot.py
Telegram бот с:
- Получением username пользователя
- Сохранением пользователя на сервере при старте
- Персонализированным приветствием

## Использование

### Для разработчиков
1. Убедитесь, что `progress.js` подключен к каждой HTML странице
2. Используйте `window.progressManager.goToNextPage()` вместо прямого перехода
3. Для сохранения формы используйте `window.progressManager.saveFormData(formData)`
4. Система автоматически сохраняет прогресс при загрузке страницы

### Для пользователей
1. Запустите бота командой `/start`
2. Откройте веб-приложение через кнопку
3. Система автоматически запомнит, где вы остановились
4. При следующем открытии вы попадете на последнюю посещенную страницу

### Для админа
Используйте скрипт `view_users.py` для просмотра данных:
```bash
# Показать всех пользователей
python view_users.py

# Показать конкретного пользователя
python view_users.py @username
```

## JSON файл

Файл `user_data.json` создается автоматически и содержит:
- `username` - username пользователя с символом @
- `form_data` - данные заполненной формы (если есть)
- `current_page` - номер последней посещенной страницы
- `created_at` - время создания записи в читаемом формате

## Безопасность

- ID пользователя генерируется локально в браузере
- Username сохраняется только при запуске бота
- Данные формы сохраняются только при заполнении
- JSON файл хранится локально на сервере
- Нет доступа к персональным данным через веб

## Отладка

Для отладки используйте консоль браузера:
```javascript
// Проверить данные пользователя
await window.progressManager.getUserData()

// Сохранить username
await window.progressManager.saveUsername('@test_user')

// Сохранить данные формы
await window.progressManager.saveFormData({
    age: '25',
    occupation: 'Тест',
    income: '50000',
    motivation: '10',
    teamwork: 'Да'
})

// Сохранить прогресс
await window.progressManager.saveProgress(3)

// Перенаправить на последнюю страницу
await window.progressManager.redirectToLastPage()
``` 