<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Debug</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        .debug-section {
            background-color: #2a2a2a;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }
        button {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            width: 100%;
        }
        .log {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: #ff4444; }
        .success { color: #4CAF50; }
        .warning { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Telegram WebApp Debug</h1>
        
        <div class="debug-section">
            <h2>üì± Telegram WebApp Status</h2>
            <div id="telegramStatus" class="log">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        </div>
        
        <div class="debug-section">
            <h2>üîó URL & Parameters</h2>
            <div id="urlInfo" class="log">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        </div>
        
        <div class="debug-section">
            <h2>üë§ User ID Detection</h2>
            <div id="userIdInfo" class="log">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        </div>
        
        <div class="debug-section">
            <h2>üåê API Connection Test</h2>
            <button onclick="testDirectFetch()">Test Direct Fetch</button>
            <button onclick="testProgressManager()">Test ProgressManager</button>
            <div id="apiTestResults" class="log">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
        </div>
        
        <div class="debug-section">
            <h2>üìä Real-time Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <div id="realtimeLogs" class="log"></div>
        </div>
    </div>

    <script src="progress.js"></script>
    <script>
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ console –º–µ—Ç–æ–¥—ã
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(message, type = 'log') {
            const logDiv = document.getElementById('realtimeLogs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'warn' ? 'warning' : 'success';
            logDiv.innerHTML += `<span class="${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== TELEGRAM DEBUG STARTED ===');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
            checkTelegramWebApp();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            checkUrlInfo();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º User ID
            checkUserIdInfo();
        });

        function checkTelegramWebApp() {
            const status = {
                telegramAvailable: !!(window.Telegram),
                webAppAvailable: !!(window.Telegram && window.Telegram.WebApp),
                version: window.Telegram?.WebApp?.version || 'N/A',
                platform: window.Telegram?.WebApp?.platform || 'N/A',
                initData: window.Telegram?.WebApp?.initData || 'N/A',
                initDataUnsafe: window.Telegram?.WebApp?.initDataUnsafe || 'N/A',
                user: window.Telegram?.WebApp?.initDataUnsafe?.user || 'N/A',
                themeParams: window.Telegram?.WebApp?.themeParams || 'N/A'
            };
            
            document.getElementById('telegramStatus').textContent = JSON.stringify(status, null, 2);
            
            if (status.webAppAvailable) {
                console.log('‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
                console.log('Version:', status.version);
                console.log('Platform:', status.platform);
                console.log('User:', status.user);
            } else {
                console.error('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        }

        function checkUrlInfo() {
            const urlInfo = {
                fullUrl: window.location.href,
                origin: window.location.origin,
                protocol: window.location.protocol,
                host: window.location.host,
                pathname: window.location.pathname,
                search: window.location.search,
                urlParams: Object.fromEntries(new URLSearchParams(window.location.search))
            };
            
            document.getElementById('urlInfo').textContent = JSON.stringify(urlInfo, null, 2);
            console.log('URL Info:', urlInfo);
        }

        function checkUserIdInfo() {
            const userIdInfo = {
                urlUserId: new URLSearchParams(window.location.search).get('user_id'),
                localStorageUserId: localStorage.getItem('user_id'),
                localStorageTelegramId: localStorage.getItem('telegram_user_id'),
                progressManagerUserId: window.progressManager?.userId || 'N/A',
                progressManagerApiBase: window.progressManager?.apiBase || 'N/A',
                progressManagerIsTelegram: window.progressManager?.isTelegramWebApp || false
            };
            
            document.getElementById('userIdInfo').textContent = JSON.stringify(userIdInfo, null, 2);
            console.log('User ID Info:', userIdInfo);
        }

        async function testDirectFetch() {
            const resultsDiv = document.getElementById('apiTestResults');
            resultsDiv.textContent = 'Testing direct fetch...\n';
            
            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π fetch –±–µ–∑ ProgressManager
                const apiBase = window.location.origin;
                const userId = new URLSearchParams(window.location.search).get('user_id') || 'test_user';
                const url = `${apiBase}/api/user/${userId}`;
                
                console.log('Testing direct fetch to:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Direct fetch response status:', response.status);
                console.log('Direct fetch response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.textContent += `‚úÖ Direct fetch SUCCESS\nStatus: ${response.status}\nData: ${JSON.stringify(data, null, 2)}\n`;
                } else {
                    const errorText = await response.text();
                    resultsDiv.textContent += `‚ùå Direct fetch FAILED\nStatus: ${response.status}\nError: ${errorText}\n`;
                }
                
            } catch (error) {
                console.error('Direct fetch error:', error);
                resultsDiv.textContent += `‚ùå Direct fetch ERROR\n${error.message}\n`;
            }
        }

        async function testProgressManager() {
            const resultsDiv = document.getElementById('apiTestResults');
            resultsDiv.textContent += '\nTesting ProgressManager...\n';
            
            try {
                if (!window.progressManager) {
                    resultsDiv.textContent += '‚ùå ProgressManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';
                    return;
                }
                
                console.log('Testing ProgressManager...');
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                const userData = await window.progressManager.getUserData();
                resultsDiv.textContent += `‚úÖ ProgressManager getUserData SUCCESS\n${JSON.stringify(userData, null, 2)}\n`;
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                await window.progressManager.saveProgress(99);
                resultsDiv.textContent += `‚úÖ ProgressManager saveProgress SUCCESS\n`;
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                const testFormData = {
                    age: "25",
                    occupation: "Telegram Debugger",
                    income: "100000 —Ä—É–±/–º–µ—Å",
                    motivation: "10 –∏–∑ 10",
                    teamwork: "–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ª–∞–¥–∫–µ"
                };
                
                await window.progressManager.saveFormData(testFormData);
                resultsDiv.textContent += `‚úÖ ProgressManager saveFormData SUCCESS\n`;
                
            } catch (error) {
                console.error('ProgressManager test error:', error);
                resultsDiv.textContent += `‚ùå ProgressManager ERROR\n${error.message}\n`;
            }
        }

        function clearLogs() {
            document.getElementById('realtimeLogs').innerHTML = '';
        }
    </script>
</body>
</html> 